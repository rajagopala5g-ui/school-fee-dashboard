<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Fee Ledger Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 1400px; margin: auto; }
        h1 { color: #007bff; text-align: center; margin-bottom: 30px; }
        .summary-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .total-amount { font-size: 2.5em; font-weight: bold; color: #28a745; text-align: center; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .control-panel, .class-summary { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        select, button { padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        .list-box { height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-top: 10px; background-color: #f9f9f9; }
        .selected-students-box { margin-top: 15px; padding: 10px; border: 1px dashed #007bff; min-height: 50px; background-color: #e9f5ff; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #fff; font-size: 0.9em; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #007bff; color: white; }
        .final-total { font-size: 1.5em; font-weight: bold; color: #dc3545; text-align: right; margin-top: 15px; padding: 10px; border-top: 2px solid #dc3545; }
        .error { color: red; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üèõÔ∏è School Fee Ledger Dashboard</h1>

    <div class="summary-card">
        <h2>Total Amount Received (All Payments)</h2>
        <div id="total-amount-received" class="total-amount">Loading...</div>
    </div>

    <div class="dashboard-grid">
        <div class="class-summary">
            <h2>Amount Received - Class Wise</h2>
            <div id="class-wise-summary">Loading...</div>
        </div>
        
        <div class="control-panel">
            <h2>Amount Received - Student Wise Query</h2>
            
            <label for="class-select">1. Select Class:</label>
            <select id="class-select" onchange="handleClassChange()">
                <option value="">-- Select a Class --</option>
            </select>

            <label for="student-select" style="margin-top: 15px; display: block;">2. Select Student(s):</label>
            <div id="student-list" class="list-box">
                <p>Select a class first.</p>
            </div>
            
            <label style="margin-top: 15px; display: block;">Selected Students:</label>
            <div id="selected-students-box" class="selected-students-box">None selected.</div>

            <button onclick="handleStudentSelection()" style="margin-top: 15px; background-color: #007bff; color: white;">3. View Transactions & Total</button>
        </div>
    </div>

    <h2>Detailed Transaction View (Columns A-L)</h2>
    <div id="transaction-results">
        <p>Select students and click 'View Transactions' to see details.</p>
    </div>
</div>

<script>
    // CSV Public URL (your provided link)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSSZ0xegXaOSZc-3xq6VAydyN04-x77OXm3uzK6YFMhTMCUqGFme9_mFKlokYl49Yc4RTZXR8myjZrI/pub?gid=1566903352&single=true&output=csv';

    // *** COLUMN INDICES (0-based) based on your updated structure ***
    const COL = {
        BILL_NO: 0,
        NEW_OR_RE: 1,
        CLASS: 2,
        STUDENT_NAME: 4, // E
        FATHER_NAME: 5, // F
        AMOUNT: 6,      // G (This value is multiplied by 1000)
        PAYMENT_MODE: 7, // H
        OLD_BALANCE: 8, // I
        ODD_CASH: 9,    // J
        DATE: 10,       // K
        // We display all columns up to index 11 (L)
        MAX_DISPLAY_COL_INDEX: 11 
    };

    let allData = []; // To store all parsed data rows
    let headers = []; // To store the header row

    // --- Core Data Fetching and Parsing ---

    async function fetchData() {
        try {
            const response = await fetch(CSV_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            parseCSV(csvText);
            initializeDashboard();
        } catch (e) {
            document.querySelector('.container').innerHTML = `<p class="error">Failed to load data. Error: ${e.message}. Please ensure the sheet is published correctly.</p>`;
        }
    }

    function parseCSV(csv) {
        const rows = csv.split('\n').filter(row => row.trim() !== '');
        if (rows.length === 0) return;
        
        // 1. Get Headers
        headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        // 2. Get Data Rows
        allData = rows.slice(1).map(row => {
            const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
            
            return {
                Class: values[COL.CLASS] || '',
                StudentName: values[COL.STUDENT_NAME] || '',
                // ** CRITICAL FIX: MULTIPLY AMOUNT (Column G) BY 1000 **
                Amount: parseFloat(values[COL.AMOUNT]) * 1000 || 0, 
                // ******************************************************
                RowData: values // Store the entire row array for detailed table display
            };
        }).filter(item => item.Amount > 0 && item.Class && item.StudentName); 
    }

    // --- Dashboard Initializations (Feature 1 & 2) ---

    function initializeDashboard() {
        // 1. Total Amount Received (Sum of G * 1000)
        const totalAmount = allData.reduce((sum, item) => sum + item.Amount, 0);
        document.getElementById('total-amount-received').textContent = `‚Çπ ${totalAmount.toFixed(2)}`;

        // 2. Amount Received - Class Wise (Pivot Table Data)
        const classMap = allData.reduce((map, item) => {
            map[item.Class] = (map[item.Class] || 0) + item.Amount;
            return map;
        }, {});

        let classHtml = '<table><tr><th>Class</th><th>Total Fees (‚Çπ)</th></tr>';
        const classes = Object.keys(classMap).sort();
        classes.forEach(cls => {
            classHtml += `<tr><td>${cls}</td><td>${classMap[cls].toFixed(2)}</td></tr>`;
        });
        classHtml += '</table>';
        document.getElementById('class-wise-summary').innerHTML = classHtml;

        // Populate Class Dropdown
        const classSelect = document.getElementById('class-select');
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.textContent = cls;
            classSelect.appendChild(option);
        });
    }

    // --- Interactive Logic (Feature 3) ---

    function handleClassChange() {
        const selectedClass = document.getElementById('class-select').value;
        const studentListDiv = document.getElementById('student-list');
        studentListDiv.innerHTML = '';
        
        if (!selectedClass) {
            studentListDiv.innerHTML = '<p>Select a class first.</p>';
            document.getElementById('selected-students-box').textContent = 'None selected.';
            document.getElementById('transaction-results').innerHTML = '<p>Select students and click \'View Transactions\' to see details.</p>';
            return;
        }

        // Get unique student names for the selected class (E column)
        const studentsInClass = Array.from(
            new Set(allData
                .filter(item => item.Class === selectedClass)
                .map(item => item.StudentName)
            )
        ).sort();
        
        // Populate custom student list (checkboxes for multi-select)
        studentsInClass.forEach(name => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `student-${name}`;
            checkbox.value = name;
            checkbox.name = 'selected-student';
            checkbox.onchange = updateSelectedStudentsBox;

            const label = document.createElement('label');
            label.htmlFor = `student-${name}`;
            label.textContent = name;
            
            const div = document.createElement('div');
            div.appendChild(checkbox);
            div.appendChild(label);
            studentListDiv.appendChild(div);
        });

        updateSelectedStudentsBox();
    }
    
    function updateSelectedStudentsBox() {
        const checkboxes = document.querySelectorAll('#student-list input:checked');
        const selectedNames = Array.from(checkboxes).map(cb => cb.value);
        
        document.getElementById('selected-students-box').textContent = 
            selectedNames.length > 0 ? selectedNames.join(', ') : 'None selected.';
    }

    function handleStudentSelection() {
        const selectedClass = document.getElementById('class-select').value;
        const checkboxes = document.querySelectorAll('#student-list input:checked');
        const selectedNames = Array.from(checkboxes).map(cb => cb.value);
        const resultsDiv = document.getElementById('transaction-results');

        if (!selectedClass || selectedNames.length === 0) {
            resultsDiv.innerHTML = '<p style="color: red;">Please select a Class and at least one Student.</p>';
            return;
        }
        
        // Filter data for selected students
        const filteredData = allData.filter(item => 
            item.Class === selectedClass && selectedNames.includes(item.StudentName)
        );

        if (filteredData.length === 0) {
            resultsDiv.innerHTML = '<p>No fee transactions found for the selected student(s) in this class.</p>';
            return;
        }

        // Calculate total amount for selected students
        const finalTotal = filteredData.reduce((sum, item) => sum + item.Amount, 0);

        // Build the results table (Columns A through L, indices 0-11)
        let tableHtml = '<table>';
        
        // Table Header: Use the actual headers array, limiting it to L (index 11)
        tableHtml += '<tr>';
        for (let i = 0; i <= COL.MAX_DISPLAY_COL_INDEX && i < headers.length; i++) {
            tableHtml += `<th>${headers[i] || 'Col ' + (i + 1)}</th>`;
        }
        tableHtml += '</tr>';
        
        // Table Body
        filteredData.forEach(item => {
            tableHtml += '<tr>';
            const rowValues = item.RowData;
            for (let i = 0; i <= COL.MAX_DISPLAY_COL_INDEX; i++) {
                let cellContent = rowValues[i] || ''; 
                
                // ** FIX: DISPLAY CORRECT AMOUNT (Column G) **
                if (i === COL.AMOUNT) {
                    // Use the already calculated and multiplied value from the item object (e.g., 20000.00)
                    cellContent = `<strong>‚Çπ ${item.Amount.toFixed(2)}</strong>`;
                }
                // *******************************************
                tableHtml += `<td>${cellContent}</td>`;
            }
            tableHtml += '</tr>';
        });
        tableHtml += '</table>';
        
        // Final Total
        tableHtml += `<div class="final-total">TOTAL FEE PAID (Selected Students): ‚Çπ ${finalTotal.toFixed(2)}</div>`;

        resultsDiv.innerHTML = tableHtml;
    }

    // Start the process
    fetchData();
</script>

</body>
</html>