<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Fee Ledger Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1000px; margin: auto; }
        h1 { color: #007bff; text-align: center; margin-bottom: 30px; }
        
        /* --- Vertical Button/Toggle Section Styles --- */
        .toggle-options { 
            display: flex; 
            flex-direction: column; /* Vertical arrangement */
            gap: 10px; 
            margin-bottom: 30px; 
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .toggle-btn { 
            padding: 18px 25px; 
            border: 2px solid #ddd;
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.15em; 
            font-weight: 600; 
            text-align: left;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .toggle-btn .icon { font-size: 1.5em; margin-right: 15px; color: #007bff; }
        .toggle-btn.active { 
            background-color: #007bff; 
            color: white; 
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4); 
            transform: translateY(-2px);
        }
        .toggle-btn.active .icon { color: white; }
        .toggle-btn:not(.active) { background-color: #f8f9fa; color: #343a40; }
        .toggle-btn:hover:not(.active) { background-color: #e9ecef; border-color: #adb5bd; }

        /* --- Content Sections --- */
        .content-section { 
            display: none; 
            padding: 30px; 
            background-color: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            min-height: 250px;
            margin-top: 20px;
        }
        .content-section.active { display: block; }
        
        /* --- Total Collection Card Styles (Retained Logic/Modified Presentation) --- */
        .summary-card { padding: 25px; border-radius: 10px; border: 3px dashed #ffc107; cursor: pointer; }
        .summary-card h2 { margin-top: 0; color: #6c757d; }
        .total-amount { font-size: 1.8em; font-weight: bold; color: #28a745; text-align: center; }
        .masked-amount { color: #dc3545; font-size: 2.5em; font-weight: bold; letter-spacing: 5px; text-align: center; }

        /* --- Class/Student Section Styles (Retained) --- */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30px; 
            margin-top: 20px;
        }
        .control-panel, .transaction-details { padding: 0; background: none; box-shadow: none; }
        select, button { padding: 12px; margin-top: 8px; border-radius: 6px; border: 1px solid #ced4da; width: 100%; box-sizing: border-box; }
        button { background-color: #28a745; color: white; }
        
        .list-box { height: 200px; overflow-y: scroll; border: 1px solid #007bff; padding: 10px; margin-top: 10px; background-color: #f0f8ff; border-radius: 6px; }
        .list-box div { margin-bottom: 5px; }

        .selected-students-box { margin-top: 15px; padding: 10px; border: 1px dashed #007bff; min-height: 50px; background-color: #e9f5ff; border-radius: 6px; font-weight: 500;}
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #fff; font-size: 0.9em; border: 1px solid #dee2e6; }
        th, td { padding: 10px; border: 1px solid #dee2e6; text-align: left; }
        th { background-color: #007bff; color: white; }
        .final-total { font-size: 1.6em; font-weight: bold; color: #dc3545; text-align: right; margin-top: 20px; padding: 10px; border-top: 3px solid #dc3545; background-color: #fff3f3; border-radius: 6px; }
        .error { color: red; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üè´ School Fee Ledger Dashboard</h1>

    <div class="toggle-options">
        <button class="toggle-btn" id="btn-total" onclick="showSection('total', 'btn-total')">
            <span class="icon">üí∞</span> View Full Collection
        </button>
        <button class="toggle-btn" id="btn-class" onclick="showSection('class', 'btn-class')">
            <span class="icon">üìä</span> View Collection Class Wise
        </button>
        <button class="toggle-btn" id="btn-student" onclick="showSection('student', 'btn-student')">
            <span class="icon">üßë‚Äçüéì</span> View Individual Student Wise
        </button>
    </div>

    <div id="section-total" class="content-section active">
        <div class="summary-card" onclick="toggleTotalAmount()">
            <h2>Total Amount Received (All Payments) <span style="font-size: 0.8em; color: #6c757d;">üîí Click to Reveal</span></h2>
            <div id="total-amount-received" class="masked-amount">‚Çπ XXXXXXXX.XX</div>
        </div>
    </div>

    <div id="section-class" class="content-section">
        <h2 style="color: #28a745;">Class Wise Fee Collection Summary (‚Çπ)</h2>
        <div id="class-wise-summary">Loading...</div>
    </div>

    <div id="section-student" class="content-section">
        <h2 style="color: #007bff; text-align: center; margin-bottom: 25px;">Individual Student Transaction Query</h2>
        <div class="dashboard-grid">
            
            <div class="control-panel">
                <h3 style="color: #343a40; margin-top: 0;">1. Student Selection</h3>
                
                <label for="class-select">Select Class:</label>
                <select id="class-select" onchange="handleClassChange()">
                    <option value="">-- Select a Class --</option>
                </select>

                <label for="student-select" style="margin-top: 15px; display: block;">Select Student(s):</label>
                <div id="student-list" class="list-box">
                    <p>Select a class first.</p>
                </div>
                
                <label style="margin-top: 15px; display: block;">Currently Selected:</label>
                <div id="selected-students-box" class="selected-students-box">None selected.</div>

                <button onclick="handleStudentSelection()" style="margin-top: 25px;">View Transactions & Total</button>
            </div>
            
            <div class="transaction-details">
                <h3 style="color: #dc3545; margin-top: 0;">2. Transaction Details (A-L)</h3>
                <div id="transaction-results">
                    <p>Select students and click 'View Transactions' to see details.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // CSV Public URL
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSSZ0xegXaOSZc-3xq6VAydyN04-x77OXm3uzK6YFMhTMCUqGFme9_mFKlokYl49Yc4RTZXR8myjZrI/pub?gid=1566903352&single=true&output=csv';

    // *** COLUMN INDICES (0-based) ***
    const COL = {
        CLASS: 2,
        STUDENT_NAME: 4, 
        AMOUNT: 6,       
        MAX_DISPLAY_COL_INDEX: 11
    };

    let allData = []; 
    let headers = []; 
    let isTotalAmountVisible = false; 
    let calculatedTotalAmount = 0; 

    // --- Core Functions (No Logic Change) ---

    function formatToIndianRupees(amount) {
        if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
        
        const [integerPart, decimalPart] = amount.toFixed(2).split('.');
        
        let lastThree = integerPart.substring(integerPart.length - 3);
        let otherNumbers = integerPart.substring(0, integerPart.length - 3);
        
        if (otherNumbers !== '') {
            lastThree = ',' + lastThree;
        }
        
        const formattedOther = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",");
        
        return `${formattedOther}${lastThree}.${decimalPart}`;
    }

    async function fetchData() {
        try {
            const response = await fetch(CSV_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            parseCSV(csvText);
            initializeDashboard();
            showSection('total', 'btn-total'); 
        } catch (e) {
            document.querySelector('.container').innerHTML = `<p class="error">Failed to load data. Error: ${e.message}. Please ensure the sheet is published correctly.</p>`;
        }
    }

    function parseCSV(csv) {
        const rows = csv.split('\n').filter(row => row.trim() !== '');
        if (rows.length === 0) return;
        
        headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        allData = rows.slice(1).map(row => {
            const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
            
            return {
                Class: values[COL.CLASS] || '',
                StudentName: values[COL.STUDENT_NAME] || '',
                Amount: parseFloat(values[COL.AMOUNT]) * 1000 || 0,¬†
                RowData: values 
            };
        }).filter(item => item.Amount > 0 && item.Class && item.StudentName);¬†
    }

    function initializeDashboard() {
        calculatedTotalAmount = allData.reduce((sum, item) => sum + item.Amount, 0);

        // Class Wise Data
        const classMap = allData.reduce((map, item) => {
            map[item.Class] = (map[item.Class] || 0) + item.Amount;
            return map;
        }, {});

        let classHtml = '<table><tr><th>Class</th><th>Total Fees (‚Çπ)</th></tr>';
        const classes = Object.keys(classMap).sort();
        classes.forEach(cls => {
            const formattedAmount = formatToIndianRupees(classMap[cls]);
            classHtml += `<tr><td>${cls}</td><td>${formattedAmount}</td></tr>`;
        });
        classHtml += '</table>';
        document.getElementById('class-wise-summary').innerHTML = classHtml;

        // Populate Class Dropdown
        const classSelect = document.getElementById('class-select');
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.textContent = cls;
            classSelect.appendChild(option);
        });
    }

    // --- Toggle Logic (No Logic Change) ---

    function showSection(sectionId, buttonId) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        document.querySelectorAll('.toggle-btn').forEach(button => {
            button.classList.remove('active');
        });

        document.getElementById(`section-${sectionId}`).classList.add('active');
        document.getElementById(buttonId).classList.add('active');
    }
    
    function toggleTotalAmount() {
        const totalAmountDiv = document.getElementById('total-amount-received');
        const header = totalAmountDiv.previousElementSibling;
        
        isTotalAmountVisible = !isTotalAmountVisible;
        
        if (isTotalAmountVisible) {
            const formattedAmount = formatToIndianRupees(calculatedTotalAmount);
            totalAmountDiv.textContent = `‚Çπ ${formattedAmount}`;
            totalAmountDiv.classList.add('total-amount');
            totalAmountDiv.classList.remove('masked-amount');
            header.innerHTML = 'Total Amount Received (All Payments) <span style="font-size: 0.8em; color: #28a745;">‚úÖ Click to Hide</span>';
        } else {
            totalAmountDiv.textContent = '‚Çπ XXXXXXXX.XX';
            totalAmountDiv.classList.add('masked-amount');
            totalAmountDiv.classList.remove('total-amount');
            header.innerHTML = 'Total Amount Received (All Payments) <span style="font-size: 0.8em; color: #6c757d;">üîí Click to Reveal</span>';
        }
    }

    function handleClassChange() {
        const selectedClass = document.getElementById('class-select').value;
        const studentListDiv = document.getElementById('student-list');
        studentListDiv.innerHTML = '';
        
        if (!selectedClass) {
            studentListDiv.innerHTML = '<p>Select a class first.</p>';
            document.getElementById('selected-students-box').textContent = 'None selected.';
            document.getElementById('transaction-results').innerHTML = '<p>Select students and click \'View Transactions\' to see details.</p>';
            return;
        }

        const studentsInClass = Array.from(
            new Set(allData
                .filter(item => item.Class === selectedClass)
                .map(item => item.StudentName)
            )
        ).sort();
        
        studentsInClass.forEach(name => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `student-${name}`;
            checkbox.value = name;
            checkbox.name = 'selected-student';
            checkbox.onchange = updateSelectedStudentsBox;

            const label = document.createElement('label');
            label.htmlFor = `student-${name}`;
            label.textContent = name;
            
            const div = document.createElement('div');
            div.appendChild(checkbox);
            div.appendChild(label);
            studentListDiv.appendChild(div);
        });

        updateSelectedStudentsBox();
    }
    
    function updateSelectedStudentsBox() {
        const checkboxes = document.querySelectorAll('#student-list input:checked');
        const selectedNames = Array.from(checkboxes).map(cb => cb.value);
        
        document.getElementById('selected-students-box').textContent = 
            selectedNames.length > 0 ? selectedNames.join(', ') : 'None selected.';
    }

    function handleStudentSelection() {
        const selectedClass = document.getElementById('class-select').value;
        const checkboxes = document.querySelectorAll('#student-list input:checked');
        const selectedNames = Array.from(checkboxes).map(cb => cb.value);
        const resultsDiv = document.getElementById('transaction-results');

        if (!selectedClass || selectedNames.length === 0) {
            resultsDiv.innerHTML = '<p style="color: red;">Please select a Class and at least one Student.</p>';
            return;
        }
        
        const filteredData = allData.filter(item => 
            item.Class === selectedClass && selectedNames.includes(item.StudentName)
        );

        if (filteredData.length === 0) {
            resultsDiv.innerHTML = '<p>No fee transactions found for the selected student(s) in this class.</p>';
            return;
        }

        const finalTotal = filteredData.reduce((sum, item) => sum + item.Amount, 0);

        let tableHtml = '<table><tr>';
        for (let i = 0; i <= COL.MAX_DISPLAY_COL_INDEX && i < headers.length; i++) {
            tableHtml += `<th>${headers[i] || 'Col ' + (i + 1)}</th>`;
        }
        tableHtml += '</tr>';
        
        filteredData.forEach(item => {
            tableHtml += '<tr>';
            const rowValues = item.RowData;
            for (let i = 0; i <= COL.MAX_DISPLAY_COL_INDEX; i++) {
                let cellContent = rowValues[i] || ''; 
                
                if (i === COL.AMOUNT) {
                    const formattedAmount = formatToIndianRupees(item.Amount);
                    cellContent = `<strong>‚Çπ ${formattedAmount}</strong>`;
                }
                tableHtml += `<td>${cellContent}</td>`;
            }
            tableHtml += '</tr>';
        });
        tableHtml += '</table>';
        
        const formattedFinalTotal = formatToIndianRupees(finalTotal);
        tableHtml += `<div class="final-total">TOTAL FEE PAID (Selected Students): ‚Çπ ${formattedFinalTotal}</div>`;

        resultsDiv.innerHTML = tableHtml;
    }

    // Start the process
    fetchData();
</script>

</body>
</html>